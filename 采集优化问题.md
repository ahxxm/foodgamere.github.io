# 采集优化问题

## 问题描述

给定玩家拥有的厨师（含已装备厨具、遗玉），将厨师分配到8个采集地图，最大化总产出率（素材/小时）。
优化器仅考虑用户已拥有的厨师和装备。

输出:
1. 每个地图的增强产出率
2. 每个地图的最优厨师组合
3. 每个地图的3个候选替换厨师（用户可根据其他用途需求手动替换任一成员）
4. 未装备采集厨具的最优放置建议（哪个厨师、哪个地图、边际产出增量）

## 采集地图

8个地图，分4个类别 (meat=肉, veg=菜, creation=面, fish=鱼)。11h产出率优于22h（除池塘外）。
厨师数为用户配置，典型值: 11h派4人, 22h派5人。

| 类别 | 地图 | 最优时段 | 基础产出率/h | 厨师数 | 素材 (采集点数阈值) |
|------|------|---------|-------------|--------|----------------|
| meat | 牧场 | 11h | 43.73 | 4 | 牛腩(1), 牛乳(6), 牛杂(13), 牛五花(19), 牛排(25) |
| meat | 鸡舍 | 11h | 62.36 | 4 | 鸡蛋(1), 鸡胸肉(4), 鸭子(8), 鸡杂(14), 鸡腿(18), 童子鸡(24) |
| meat | 猪圈 | 11h | 45.23 | 4 | 猪腿肉(1), 猪油(5), 猪杂(7), 里脊肉(12), 梅花肉(18) |
| veg | 菜棚 | 11h | 120.95 | 4 | 青菜(1), 番茄(4), 青椒(8), 黄瓜(15), 豆子(20), 白萝卜(25) |
| veg | 菜地 | 11h | 126.41 | 4 | 葱(1), 辣椒(5), 土豆(8), 茄子(16), 水果(22), 南瓜(30) |
| veg | 森林 | 11h | 85.55 | 4 | 白菜(2), 香菇(6), 胡萝卜(12), 洋葱(17), 笋(27), 茶叶(32) |
| creation | 作坊 | 11h | 125.64 | 4 | 面粉(1), 大米(5), 豆腐(11), 糯米(16), 酒(21), 咖喱(26) |
| fish | 池塘 | 22h | 36.45 | 5 | 贝壳(5), 虾(9), 冻鱼(14), 鲜鱼(19), 螃蟹(24), 鱼翅(29) |

基础产出率 = 所有素材 avg(min, max) 之和 / 小时，无任何加成。

### 数据结构

`data/data.min.json` → `maps[]`，每个 map:
- `name`: 地图名
- `time[]`: 5个时段的秒数
- `materials[]`: 每个素材有 `name`, `skill`(采集点数阈值), `quantity[timeIdx][min,max]`

### 产出公式

```
for each material in map.materials:
    base = avg(quantity[timeIdx][0], quantity[timeIdx][1])
    yield = ceil(base × (1 + total_addition% / 100))

map_rate = Σ yield / hours
```

`total_addition%` 定义见下文"地图总加成"。

约束: 每个地图分配的厨师采集点数之和必须 >= 该地图最高素材的 skill 阈值（如牧场需 >= 25，池塘需 >= 29），以确保所有素材均可产出。

## 厨师采集属性

每个厨师有4个基础采集属性: `meat`, `creation`, `veg`, `fish` (0-10 范围)。

### effective_gain% 计算

每个厨师的采集加成百分比:

```
// 汇总所有 Material_Gain 来源（flat部分直接加，暴击部分取期望值）
base_gain = Σ flat Material_Gain.value from:
    1. chef.specialSkillEffect  (厨师自身技能)
    2. equipped 厨具 的 skill effects (仅 flat，暴击类见下)
    3. disk.ambers[].allEffect[disk.level - 1]  (遗玉效果)

// 厨具暴击: desc 匹配 /(\d+)%概率.*?(\d+)%素材/ → expected = rate × bonus
equip_crit_expected = Σ (rate × bonus) for 暴击类厨具

// 厨师修炼暴击: 从 ultimateSkillEffect + ultimateSkillDisp 解析
chef_crit_rate = regex /(\d+)%/ from chef.ultimateSkillDisp
chef_crit_bonus = Material_Gain.value from chef.ultimateSkillEffect

effective_gain = base_gain + equip_crit_expected + chef_crit_rate × chef_crit_bonus
```

### 类别特化加成 (type_bonus)

仅在对应类别地图生效:

```
type_bonus = Σ Material_<category>.value from:
    1. 遗玉 (e.g., 积海陨 lv5 = Material_Meat +8%)
    2. 厨具 (e.g., 镀金封印灯 = Material_Meat +8%)
```

厨师在某地图的总采集价值 = effective_gain + type_bonus[该地图类别]
### 地图总加成

所有分配到该地图的厨师的采集价值之和:

```
total_addition% = Σ (chef_i.effective_gain + chef_i.type_bonus[category])
enhanced_rate = base_rate × (1 + total_addition% / 100)
```

## 厨具

已装备的厨具效果计入该厨师的 effective_gain 和 type_bonus。未装备的采集厨具作为候选建议输出。

### 厨具效果类型

厨具通过 `equips[].skill[]` 指向 `skills[]` 表获取效果。效果有3种:

1. 采集属性 (Meat/Veg/Fish/Creation, cal=Abs): 加采集点数，如 Meat+4
2. Material_Gain (cal=Percent): 通用素材获得加成%。分两种:
   - flat: desc 为 "素材获得+X%" → 直接加 X%
   - 暴击: desc 匹配 `/(\d+)%概率.*?(\d+)%素材/` → 期望值 = rate × bonus (如 5%概率20% → 期望1%)
3. Material_\<category\> (cal=Percent): 类别特化加成%，仅在对应类别地图生效。如 Material_Meat+8%

同一厨具可同时包含多种效果（如金丝筒靴: 全采集+3 且 Material_Gain+8%）。

## 遗玉

类别特化遗玉，装在厨师心法盘(disk)的 Green slot (type=2) 上。
disk.info[] 定义各槽位类型: 1=Red, 2=Green, 3=Blue。所有采集类遗玉均为 Green slot。

| 系列 | 类型 | 1星(岩)lv5 | 2星(玉)lv5 | 3星(陨)lv5 |
|------|------|-----------|-----------|-----------|
| 积海 | Material_Meat | +5% | +6% | +8% |
| 鱼贯 | Material_Fish | +5% | +6% | +8% |
| 秋实 | Material_Vegetable | +5% | +6% | +8% |
| 满载 | Material_Creation | +5% | +6% | +8% |

公式: `value = base + (level - 1) × amplification`, amplification=1

仅5星厨师可升至disk最高等级(lv5)。

候选评估: 厨师的 Green slot 数量影响其采集潜力。高采集点数 + 2个Green slot的厨师可装备2个采集遗玉，即使当前未装备，也应作为候选展示。候选输出应包含 Green slot 数量供用户参考。

## 排除项

- 修炼/Global效果: 技能 condition="Global" 的效果（如全体肉类+5%），属修炼系统，不在本优化范围
- 厨具分配优化: 已装备厨具视为固定输入。未装备厨具仅作为候选建议
- OpenTime效果: 部分厨师/厨具有派遣时间修改效果，暂不纳入优化

## 数据来源

- `data/data.min.json`:
  - `maps[]`: 地图、时段、素材、产出量
  - `chefs[]`: 厨师属性 (meat/creation/veg/fish, skill, ultimateSkillList)
  - `skills[]`: 技能效果 (Material_Gain, Material_Meat 等)
  - `equips[]`: 厨具 (skill[] 指向 skills 表)
  - `ambers[]`: 遗玉 (skill[] 指向 skills 表, amplification, rarity)
- 用户存档 (archive.json / 前端传入):
  - 拥有的厨师 (Got=true)
  - 每个厨师的 equipId (当前装备)
  - 每个厨师的 disk: {level, ambers[{data, ...}]}
  - 未装备的采集厨具列表

## 算法

### Phase 1: 计算采集价值

对每个拥有的厨师:
1. 解析 specialSkillEffect → 提取 Material_Gain (flat)
2. 解析 ultimateSkillEffect + ultimateSkillDisp → 提取暴击期望
3. 读取已装备厨具 → 提取 Material_Gain (解析desc判断是flat还是暴击)
4. 读取 disk 遗玉 → 提取 Material_Gain 和 Material_<category>
5. 汇总: effective_gain% + per-category type_bonus%

### Phase 2: 贪心分配

分配目标: 选择每个地图的厨师组合，使8个地图的总产出率最大。

```
available = all owned chefs
assigned = {}  // map -> {team, candidates}

for each map (sorted by base_rate desc):
    category = map.category
    // 对每个候选厨师，计算其在该地图的边际产出贡献
    // marginal = base_rate × (effective_gain + type_bonus[category]) / 100
    // 取 marginal 最高的前K个（K=该地图厨师数）
    // 竞争处理: 若某厨师已被更高 base_rate 的地图选走，跳过
    ranked = available sorted by (effective_gain + type_bonus[category]) desc
    team = ranked[:K]
    candidates = ranked[K:K+3]  // 3个候选，可替换team中任一成员
    assigned[map] = {team, candidates}
    remove team from available
```

### Phase 3: 厨具建议

对每个未装备的采集厨具，遍历所有已分配的 (厨师, 地图) 组合:
```
for each spare_equip:
    best = nil
    for each (map, team) in assigned:
        for each chef in team:
            old_gain = chef当前厨具对该地图的贡献 (Material_Gain + type_bonus[category])
            new_gain = spare_equip对该地图的贡献
            delta = new_gain - old_gain
            marginal_rate = map.base_rate × delta / 100
            if marginal_rate > best:
                best = {chef, map, marginal_rate}
    recommend best
```

## 输出格式

```
=== 采集优化结果 ===

地图: 鸡舍 (11h, 4厨师)
  基础产出率: 62.36/h
  增强产出率: XX.XX/h (+YY.Y%)
  采集点数: NN (meat)
  厨师: 忌璃(64.0%), 冰果(59.0%), 四郎(42.0%), 朗十一(30.0%)  // % = effective_gain + type_bonus[该地图]
  候选: 水镜(30.0%), 卷卷猫(35.0%), 花仙子(22.0%)

...每个地图...

=== 总产出率 ===
  基础: XXX.XX/h
  增强: XXX.XX/h (+YY.Y%)

=== 未装备厨具建议 ===
  金龙池 → 厨师X @ 池塘, 预计 +Z.ZZ/h
  ...
```

## 顶级采集厨师参考

| 厨师 | 星 | 基础gain% | 暴击 | 期望gain% | meat | fish | veg | crea |
|------|---|----------|------|----------|------|------|-----|------|
| 风里希 | 5 | 40 | 30%→80% | 64.0 | 0 | 0 | 6 | 7 |
| 忌璃 | 5 | 40 | 30%→80% | 64.0 | 7 | 0 | 7 | 0 |
| 冰果 | 5 | 35 | 30%→80% | 59.0 | 9 | 0 | 9 | 0 |
| 四郎 | 4 | 24 | 30%→60% | 42.0 | 8 | 8 | 8 | 8 |
| 槐鸮 | 4 | 25 | 25%→60% | 40.0 | 0 | 0 | 7 | 4 |
| 烈阳 | 5 | 40 | - | 40.0 | 6 | 6 | 0 | 0 |
| 卷卷猫 | 4 | 20 | 30%→50% | 35.0 | 6 | 0 | 6 | 0 |
| 簪娘 | 5 | 30 | - | 30.0 | 7 | 7 | 0 | 0 |
| 青天判官 | 5 | 30 | - | 30.0 | 7 | 5 | 0 | 0 |
| 水镜 | 4 | 20 | 20%→50% | 30.0 | 5 | 0 | 8 | 0 |
| 游遥 | 4 | 20 | 20%→50% | 30.0 | 0 | 8 | 6 | 0 |
| 朗十一 | 4 | 20 | 20%→50% | 30.0 | 8 | 6 | 0 | 0 |
| 花仙子 | 3 | 12 | 20%→50% | 22.0 | 0 | 5 | 6 | 0 |
| 阿柱 | 2 | 12 | 10%→30% | 15.0 | 0 | 8 | 8 | 0 |
